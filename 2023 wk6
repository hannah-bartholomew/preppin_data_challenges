with cte as (
select customer_id
,split_part(preferences, '___',1) as mobile_or_online
,split_part(preferences, '___',2) as preferences
,score
from TIL_PLAYGROUND.PREPPIN_DATA_INPUTS.PD2023_WK06_DSB_CUSTOMER_SURVEY
unpivot(score for preferences in(MOBILE_APP___EASE_OF_USE, MOBILE_APP___EASE_OF_ACCESS, MOBILE_APP___NAVIGATION, MOBILE_APP___LIKELIHOOD_TO_RECOMMEND, MOBILE_APP___OVERALL_RATING, ONLINE_INTERFACE___EASE_OF_USE, ONLINE_INTERFACE___EASE_OF_ACCESS, ONLINE_INTERFACE___NAVIGATION, ONLINE_INTERFACE___LIKELIHOOD_TO_RECOMMEND, ONLINE_INTERFACE___OVERALL_RATING))
)


,AVG_RANK AS(
select CUSTOMER_ID
,MOBILE_OR_ONLINE
,ROUND((EASE_OF_USE + EASE_OF_ACCESS + NAVIGATION + LIKELIHOOD_TO_RECOMMEND)/4,2) AS AVERAGE_SCORE
from cte
pivot (avg(score) for PREFERENCES in ('EASE_OF_USE', 'EASE_OF_ACCESS', 'NAVIGATION','LIKELIHOOD_TO_RECOMMEND','OVERALL_RATING')) AS P
(CUSTOMER_ID,MOBILE_OR_ONLINE,EASE_OF_USE,EASE_OF_ACCESS,NAVIGATION,LIKELIHOOD_TO_RECOMMEND,OVERALL_RATING)
)

,FINAL_CTE AS (
SELECT *
,(MOBILE_APP-ONLINE_INTERFACE) AS RATING_DIFFERENCE
,(CASE
WHEN RATING_DIFFERENCE>=2 THEN 'MOBILE APP SUPERFAN'
WHEN RATING_DIFFERENCE>=1 THEN 'MOBILE APP FAN'
WHEN RATING_DIFFERENCE<=-2 THEN 'ONLINE INTERFACE SUPERFAN'
WHEN RATING_DIFFERENCE<=-1 THEN 'ONLINE INTERFACE FAN'
ELSE 'NEUTRAL' END) AS FAN_CLUB
FROM AVG_RANK
PIVOT(AVG(AVERAGE_SCORE) FOR MOBILE_OR_ONLINE IN ('MOBILE_APP','ONLINE_INTERFACE')) AS P
(CUSTOMER_ID,MOBILE_APP,ONLINE_INTERFACE)
)

SELECT 
ROUND((COUNT(DISTINCT CUSTOMER_ID))/(SELECT COUNT(DISTINCT CUSTOMER_ID) FROM CTE)*100,1) AS PERCENT_OF_TOTAL
,FAN_CLUB
FROM FINAL_CTE
GROUP BY FAN_CLUB
