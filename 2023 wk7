WITH ACCOUNT_INFO AS (
select ACCOUNT_NUMBER
,ACCOUNT_TYPE 
,BALANCE_DATE 
,BALANCE
,VALUE AS ACCOUNT_HOLDER_ID
from TIL_PLAYGROUND.PREPPIN_DATA_INPUTS.PD2023_WK07_ACCOUNT_INFORMATION, lateral split_to_table(account_holder_id,',')
where account_holder_id is not null
)

,HOLDERS AS (
SELECT ACCOUNT_HOLDER_ID
,NAME
,DATE_OF_BIRTH
,FIRST_LINE_OF_ADDRESS
,'0'||TO_VARCHAR(CONTACT_NUMBER) AS CONTACT_NUMBER
FROM TIL_PLAYGROUND.PREPPIN_DATA_INPUTS.PD2023_WK07_ACCOUNT_HOLDERS
)

,ACCOUNT AS(
SELECT NAME
,ACCOUNT_NUMBER
,H.ACCOUNT_HOLDER_ID
,ACCOUNT_TYPE
,DATE_OF_BIRTH
,FIRST_LINE_OF_ADDRESS
,CONTACT_NUMBER
,BALANCE_DATE 
,BALANCE

FROM ACCOUNT_INFO AS A
INNER JOIN HOLDERS AS H
ON H.ACCOUNT_HOLDER_ID=A.ACCOUNT_HOLDER_ID
)

,TRANSACTION AS(
select P.TRANSACTION_ID
,ACCOUNT_TO
,ACCOUNT_FROM
,TRANSACTION_DATE
,VALUE
,CANCELLED_
from
TIL_PLAYGROUND.PREPPIN_DATA_INPUTS.PD2023_WK07_TRANSACTION_DETAIL as D
inner join TIL_PLAYGROUND.PREPPIN_DATA_INPUTS.PD2023_WK07_TRANSACTION_PATH AS P
ON D.TRANSACTION_ID=P.TRANSACTION_ID
)

SELECT
ACCOUNT_NUMBER
,ACCOUNT_TYPE
,DATE_OF_BIRTH
,FIRST_LINE_OF_ADDRESS
,CONTACT_NUMBER
,BALANCE_DATE 
,BALANCE
,ACCOUNT_TO
,TRANSACTION_DATE
,VALUE
,CANCELLED_
,TRANSACTION_ID
FROM
ACCOUNT AS ACC
INNER JOIN TRANSACTION AS T
ON ACCOUNT_FROM=ACCOUNT_NUMBER
WHERE CANCELLED_='N'AND VALUE>1000 AND ACCOUNT_TYPE !='Platinum'
